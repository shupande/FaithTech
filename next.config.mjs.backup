/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    domains: ['localhost'],
  },
  webpack: (config, { isServer }) => {
    if (isServer) {
      config.externals = [
        ...config.externals,
        'fluent-ffmpeg',
        '@ffmpeg-installer/ffmpeg'
      ]
    }
    
    // 忽略其他平台的 ffmpeg 文件
    config.resolve = config.resolve || {}
    config.resolve.alias = {
      ...config.resolve.alias,
      // Windows 环境下保留 win32-x64，忽略其他
      ...(process.platform === 'win32' && {
        '@ffmpeg-installer/darwin-arm64': false,
        '@ffmpeg-installer/darwin-x64': false,
        '@ffmpeg-installer/linux-arm': false,
        '@ffmpeg-installer/linux-arm64': false,
        '@ffmpeg-installer/linux-ia32': false,
        '@ffmpeg-installer/linux-x64': false,
        '@ffmpeg-installer/win32-ia32': false,
      }),
      // Linux 环境下保留 linux-x64，忽略其他
      ...(process.platform === 'linux' && {
        '@ffmpeg-installer/darwin-arm64': false,
        '@ffmpeg-installer/darwin-x64': false,
        '@ffmpeg-installer/linux-arm': false,
        '@ffmpeg-installer/linux-arm64': false,
        '@ffmpeg-installer/linux-ia32': false,
        '@ffmpeg-installer/win32-x64': false,
        '@ffmpeg-installer/win32-ia32': false,
      }),
      // macOS 环境下保留对应架构，忽略其他
      ...(process.platform === 'darwin' && {
        '@ffmpeg-installer/linux-arm': false,
        '@ffmpeg-installer/linux-arm64': false,
        '@ffmpeg-installer/linux-ia32': false,
        '@ffmpeg-installer/linux-x64': false,
        '@ffmpeg-installer/win32-x64': false,
        '@ffmpeg-installer/win32-ia32': false,
        // 根据 CPU 架构选择保留的版本
        ...((process.arch === 'arm64') ? {
          '@ffmpeg-installer/darwin-x64': false,
        } : {
          '@ffmpeg-installer/darwin-arm64': false,
        }),
      }),
    }
    
    return config
  }
}

export default nextConfig 